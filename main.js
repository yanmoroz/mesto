(()=>{"use strict";const e={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},t=document.querySelector(".profile__edit-button"),s=document.querySelector(".popup__form_kind_edit"),n=document.querySelector("#name-input"),i=document.querySelector("#about-input"),o=document.querySelector(".profile__avatar-container"),r=document.querySelector(".profile__add-button"),a=document.querySelector(".popup__form_kind_add"),l=document.querySelector(".popup__form_kind_change-avatar"),d=document.querySelector(".container"),c=document.querySelector(".main-loader"),u="Сохранить",h="Сохранение...";class _{constructor({cardModel:e,isCurrentUserOwner:t,hasCurrentUserLike:s,cardSelector:n,handleCardClick:i,handleDeleteButtonClick:o,handleLikeButtonClick:r}){this._cardSelector=n,this._cardModel=e,this._isCurrentUserOwner=t,this._hasCurrentUserLike=s,this._handleCardClick=i,this._handleDeleteButtonClick=o,this._handleLikeButtonClick=r}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".card").cloneNode(!0)}generateCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".card__image"),this._cardTitle=this._element.querySelector(".card__title"),this._likeButton=this._element.querySelector(".card__like-button"),this._removeButton=this._element.querySelector(".card__remove-button"),this._likesCounter=this._element.querySelector(".card__like-counter"),this._isCurrentUserOwner||this._removeButton.classList.add("card__remove-button_hidden"),this.updateLikeButtonState({isLiked:this._hasCurrentUserLike,likesCount:this._cardModel.likes.length}),this._cardImage.src=this._cardModel.link,this._cardImage.alt=this._cardModel.name,this._cardTitle.textContent=this._cardModel.name,this._setEventListeners(),this._element}getCardId(){return this._cardModel._id}removeItem(){this._element.remove(),this._element=null}updateLikeButtonState({isLiked:e,likesCount:t}){this._hasCurrentUserLike=e,e?this._likeButton.classList.add("card__like-button_liked"):this._likeButton.classList.remove("card__like-button_liked"),this._likesCounter.textContent=t}_setEventListeners(){this._likeButton.addEventListener("click",(()=>this._handleLikeButtonClick(this._hasCurrentUserLike))),this._removeButton.addEventListener("click",(()=>this._handleDeleteButtonClick())),this._cardImage.addEventListener("click",(()=>this._handleCardClick(this._name,this._imageURL)))}}class p{constructor({validationConfig:e,formElement:t}){this._validationConfig=e,this._formElement=t,this._inputList=Array.from(this._formElement.querySelectorAll(this._validationConfig.inputSelector)),this._buttonElement=this._formElement.querySelector(this._validationConfig.submitButtonSelector)}enableValidation(){this._formElement.addEventListener("submit",(e=>e.preventDefault())),this._setEventListeners()}resetFormValidationState(){this._inputList.forEach((e=>{this._hideInputError(e)})),this._toggleButtonState()}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}_showInputError(e,t){const s=this._formElement.querySelector(`.${e.id}-error`);e.classList.add(this._validationConfig.inputErrorClass),s.textContent=t,s.classList.add(this._validationConfig.errorClass)}_hideInputError(e){const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.remove(this._validationConfig.inputErrorClass),t.classList.remove(this._validationConfig.errorClass),t.textContent=""}_toggleButtonState(){this._hasInvalidInput()?(this._buttonElement.classList.add(this._validationConfig.inactiveButtonClass),this._buttonElement.setAttribute("disabled",!0)):(this._buttonElement.classList.remove(this._validationConfig.inactiveButtonClass),this._buttonElement.removeAttribute("disabled"))}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}}class m{constructor({popupSelector:e}){this._popup=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this),this._handlePopupClick=this._handlePopupClick.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popup.addEventListener("click",this._handlePopupClick)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handlePopupClick(e){(e.target.classList.contains("popup")||e.target.classList.contains("popup__close-button"))&&this.close()}}class k extends m{constructor({popupSelector:e,handlePopupOpening:t,handleFormSubmit:s}){super({popupSelector:e}),this._form=this._popup.querySelector(".popup__form"),this._inputList=this._form.querySelectorAll(".popup__input"),this._submitButton=this._form.querySelector(".popup__button"),this._handleFormSubmit=s,this._handlePopupOpening=t}_getInputValues(){const e={};return this._inputList.forEach((t=>{e[t.name]=t.value})),e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}open(e){this._context=e,this._handlePopupOpening&&this._handlePopupOpening(),super.open()}close(){this._context=null,super.close(),this._form.reset()}getContext(){return this._context}updateSubmitButtonTitle({title:e}){this._submitButton.textContent=e}}const v=new class{constructor({options:e}){this._baseUrl=e.baseUrl,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}getUserInfo(){return fetch(`${this._baseUrl}/users/me`,{method:"GET",headers:this._headers}).then(this._checkResponse)}getCards(){return fetch(`${this._baseUrl}/cards`,{method:"GET",headers:this._headers}).then(this._checkResponse)}updateUserInfo({name:e,about:t}){return fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._checkResponse)}postNewCard({cardInfo:e}){return fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify(e)}).then(this._checkResponse)}deleteCard({cardId:e}){return fetch(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}addLike({cardId:e}){return fetch(`${this._baseUrl}/cards/likes/${e}`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}removeLike({cardId:e}){return fetch(`${this._baseUrl}/cards/likes/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}changeAvatar({avatarLink:e}){return fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}}({options:{baseUrl:"https://mesto.nomoreparties.co/v1/cohort-26",headers:{authorization:"16ebd79b-43e1-4359-bd06-6780c368e10f","Content-Type":"application/json"}}}),C=new p({validationConfig:e,formElement:s}),S=new p({validationConfig:e,formElement:a}),f=new p({validationConfig:e,formElement:l});[C,S,f].forEach((e=>e.enableValidation()));const g=new class{constructor({nameSelector:e,aboutSelector:t,avatarSelector:s}){this._name=document.querySelector(e),this._about=document.querySelector(t),this._avatar=document.querySelector(s)}getUserInfo(){return this._model}setUserInfo({userInfoModel:e}){this._model=e,this._name.textContent=e.name,this._about.textContent=e.about,this._avatar.src=e.avatar}}({nameSelector:".profile__name",aboutSelector:".profile__about",avatarSelector:".profile__avatar"}),b=new class{constructor({containerSelector:e}){this._container=document.querySelector(e)}renderItems({items:e,renderer:t}){this._items=e,this._renderer=t,this._items.forEach((e=>this._renderer(e)))}addItem({item:e}){this._container.prepend(e)}}({containerSelector:".cards-list"}),L=new k({popupSelector:".popup_kind_edit",handlePopupOpening:()=>{const e=g.getUserInfo();n.value=e.name,i.value=e.about,C.resetFormValidationState()},handleFormSubmit:e=>{L.updateSubmitButtonTitle({title:h}),v.updateUserInfo({name:e.profileName,about:e.profileAbout}).then((e=>{g.setUserInfo({userInfoModel:e}),L.close()})).catch((e=>console.log(e))).finally((()=>{L.updateSubmitButtonTitle({title:u})}))}}),E=new k({popupSelector:".popup_kind_add",handlePopupOpening:()=>{S.resetFormValidationState()},handleFormSubmit:e=>{E.updateSubmitButtonTitle({title:"Добавление..."}),v.postNewCard({cardInfo:{name:e.placeName,link:e.placeImage}}).then((e=>{const t=U(e);b.addItem({item:t}),E.close()})).catch((e=>console.log(e))).finally((()=>{E.updateSubmitButtonTitle({title:"Добавить"})}))}}),I=new k({popupSelector:".popup_kind_change-avatar",handlePopupOpening:()=>{f.resetFormValidationState()},handleFormSubmit:e=>{I.updateSubmitButtonTitle({title:h}),v.changeAvatar({avatarLink:e.avatarLink}).then((e=>{g.setUserInfo({userInfoModel:e}),I.close()})).catch((e=>console.log(e))).finally((()=>{I.updateSubmitButtonTitle({title:u})}))}}),y=new class extends m{constructor({popupSelector:e}){super({popupSelector:e}),this._popupCardImage=this._popup.querySelector(".popup__place-image"),this._captionImage=this._popup.querySelector(".popup__place-name")}open({name:e,imagePath:t}){this._popupCardImage.src=t,this._popupCardImage.alt=this._captionImage.textContent=e,super.open()}}({popupSelector:".popup_kind_image"}),B=new k({popupSelector:".popup_kind_delete-comfirm",handleFormSubmit:()=>{B.updateSubmitButtonTitle({title:"Удаление..."});const e=B.getContext(),t=e.getCardId();v.deleteCard({cardId:t}).then((()=>{e.removeItem(),B.close()})).catch((e=>console.log(e))).finally((()=>{B.updateSubmitButtonTitle({title:"Да"})}))}}),U=e=>{const t=g.getUserInfo(),s=e.owner._id===t._id,n=e.likes.some((e=>e._id===t._id)),i=new _({cardModel:e,isCurrentUserOwner:s,hasCurrentUserLike:n,cardSelector:"#card",handleCardClick:()=>y.open({name:e.name,imagePath:e.link}),handleDeleteButtonClick:()=>B.open(i),handleLikeButtonClick:t=>{t?v.removeLike({cardId:e._id}).then((e=>{i.updateLikeButtonState({isLiked:!1,likesCount:e.likes.length})})).catch((e=>console.log(e))):v.addLike({cardId:e._id}).then((e=>{i.updateLikeButtonState({isLiked:!0,likesCount:e.likes.length})})).catch((e=>console.log(e)))}});return i.generateCard()};t.addEventListener("click",(function(){L.open()})),r.addEventListener("click",(function(){E.open()})),o.addEventListener("click",(function(){I.open()})),E.setEventListeners(),L.setEventListeners(),y.setEventListeners(),I.setEventListeners(),B.setEventListeners(),Promise.all([v.getUserInfo(),v.getCards()]).then((e=>{const t=e[0],s=e[1];g.setUserInfo({userInfoModel:t}),b.renderItems({items:s.reverse(),renderer:e=>{const t=U(e);b.addItem({item:t})}})})).catch((e=>console.log(e))).finally((()=>{d.classList.add("container_visible"),c.classList.add("main-loader_hidden")}))})();